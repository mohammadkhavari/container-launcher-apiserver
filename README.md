# container-launcher-api

<h2 align="center">
    Container Launcher API: API Server Implemented with Django Rest Framework and Docker Engine SDK
</h2>

## Run Server

1. Create and activate virtual enviornment to separate dependencies:

```bash
    python3 -m venv env
    source env/bin/activate
```

2. install dependencies:

```bash
    pip3 install -r requirements.txt
```

3. run server:

```bash
    python3 manage.py migrate
    python3 manage.py runserver
```

## Features

- CRUD operations for Apps
- Run apps
- History of app launchs

## Examples

### Below examples are generated by Httpie cli http client tool

1. Create Apps from redis:

```bash
http POST http://127.0.0.1:8000/apps/ name=my-app command="sleep 1000" \
image="hub.hamdocker.ir/redis/redis-stack-server:7.0.2-RC1" \
envs:='{"ALLOW_EMPTY_PASSWORD":"yes", "REDIS_ARGS": "--requirepass redis-stack"}'
```

```http
HTTP/1.1 201 Created
Allow: GET, POST, HEAD, OPTIONS
Content-Length: 226
Content-Type: application/json
...

{
    "command": "sleep 1000",
    "created": "2022-10-27T00:28:35.875267Z",
    "envs": {
        "ALLOW_EMPTY_PASSWORD": "yes",
        "REDIS_ARGS": "--requirepass redis-stack"
    },
    "id": 1,
    "image": "hub.hamdocker.ir/redis/redis-stack-server:7.0.2-RC1",
    "name": "my-app"
}
```

2. and an nginx app

```bash
http POST http://127.0.0.1:8000/apps/ name=my-nginx command="ls" \
image="hub.hamdocker.ir/nginx:1.21" \
envs:='{"NGINX_HOST":"foobar.com", "NGINX_PORT":"80"}'
```

   ```http
HTTP/1.1 201 Created
...

{
    "command": "ls",
    "created": "2022-10-27T05:16:06.247507Z",
    "envs": {
        "NGINX_HOST": "foobar.com",
        "NGINX_PORT": "80"
    },
    "id": 2,
    "image": "hub.hamdocker.ir/nginx:1.21",
    "name": "my-nginx"
}
```

3. list all apps:

```bash
http http://127.0.0.1:8000/apps/
```

   ```http
HTTP/1.1 200 OK

{
    "count": 2,
    "next": null,
    "previous": null,
    "results": [
        {
            "command": "sleep 1000",
            "created": "2022-10-27T00:28:35.875267Z",
            "envs": {
                "ALLOW_EMPTY_PASSWORD": "yes",
                "REDIS_ARGS": "--requirepass redis-stack"
            },
            "id": 1,
            "image": "hub.hamdocker.ir/redis/redis-stack-server:7.0.2-RC1",
            "name": "my-app"
        },
        {
            "command": "ls",
            "created": "2022-10-27T05:16:06.247507Z",
            "envs": {
                "NGINX_HOST": "foobar.com",
                "NGINX_PORT": "80"
            },
            "id": 2,
            "image": "hub.hamdocker.ir/nginx:1.21",
            "name": "my-nginx"
        }
    ]
}
```

4. Run app by id:

```bash
http POST http://127.0.0.1:8000/apps/2/run
```

   ```http
HTTP/1.1 200 OK

{
    "app_name": "my-nginx",
    "command": "ls",
    "envs": {
        "NGINX_HOST": "foobar.com",
        "NGINX_PORT": "80"
    },
    "id": "1aacd9270343133b7ea9e9bbd41af7c01f2982778ae7d6ad5ee7ff18655b7b4c",
    "image": "hub.hamdocker.ir/nginx:1.21",
    "launched_at": "2022-10-27T05:54:11.917532224Z",
    "status": "Running"
}
```

Update App data and run another instance of it:

```bash
http PATCH http://127.0.0.1:8000/apps/2/ name=my-nginx-updated command="sleep 1000" \
envs:='{"NGINX_PORT":"8080"}'
```

```http
HTTP/1.1 200 OK

{
    "command": "sleep 1000",
    "created": "2022-10-27T05:16:06.247507Z",
    "envs": {
        "NGINX_PORT": "8080"
    },
    "id": 2,
    "image": "hub.hamdocker.ir/nginx:1.21",
    "name": "my-nginx-updated"
}
```

run another instance of app with appId 2

```bash
http POST http://127.0.0.1:8000/apps/2/run
```

```http
HTTP/1.1 200 OK

{
    "app_name": "my-nginx-updated",
    "command": "sleep 1000",
    "envs": {
        "NGINX_PORT": "8080"
    },
    "id": "e2695316bdaf46bf5b8b379885ad9f58b96920dc8ee43684b4f224c183b069c6",
    "image": "hub.hamdocker.ir/nginx:1.21",
    "launched_at": "2022-10-27T05:56:28.154031041Z",
    "status": "Running"
}
```

5. list history of app launches

```bash
http GET http://127.0.0.1:8000/apps/2/run
```

```http
HTTP/1.1 200 OK

[
{
        "app_name": "my-nginx-updated",
        "command": "sleep 1000",
        "envs": {
            "NGINX_PORT": "8080"
        },
        "id": "e2695316bdaf46bf5b8b379885ad9f58b96920dc8ee43684b4f224c183b069c6",
        "image": "hub.hamdocker.ir/nginx:1.21",
        "launched_at": "2022-10-27T05:56:28.154031041Z",
        "status": "Running"
    },

    {
        "app_name": "my-nginx",
        "command": "ls",
        "envs": {
            "NGINX_HOST": "foobar.com",
            "NGINX_PORT": "80"
        },
        "id": "1aacd9270343133b7ea9e9bbd41af7c01f2982778ae7d6ad5ee7ff18655b7b4c",
        "image": "hub.hamdocker.ir/nginx:1.21",
        "launched_at": "2022-10-27T05:54:11.917532224Z",
        "status": "Finished"
    }
]
```

6. Proper messages on docker engine errors:

   ```bash
   $ http http://127.0.0.1:8000/apps/ name=my-nginx command="/bin/bash"
   image="hub.hamdocker.ir/khiar:2.17" envs:='{"PATH":""}'

   $ http POST http://127.0.0.1:8000/apps/3/run
   ```

   ```http

   HTTP/1.1 400 Bad Request
   Allow: GET, POST, HEAD, OPTIONS
   Content-Length: 39
   Content-Type: application/json
   Cross-Origin-Opener-Policy: same-origin
   Date: Thu, 27 Oct 2022 06:04:00 GMT
   Referrer-Policy: same-origin
   Server: WSGIServer/0.2 CPython/3.9.5
   Vary: Accept, Cookie
   X-Content-Type-Options: nosniff
   X-Frame-Options: DENY

   {
       "detail": "App image is not available"
   }
   ```
